<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="generator" content="Asciidoctor 2.0.10"/>
<title>Cluster-api-provider-metal3</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"/>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Cluster-api-provider-metal3</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_cluster_api_provider_metal">1. Cluster API provider Metal³</a>
<ul class="sectlevel2">
<li><a href="#_setup">1.1. Setup</a></li>
<li><a href="#_pivoting_or_updating_ironic">1.2. Pivoting or updating Ironic</a></li>
</ul>
</li>
<li><a href="#_setting_up_a_development_environment">2. Setting up a development environment</a>
<ul class="sectlevel2">
<li><a href="#_pre_requisites_2">2.1. Pre-requisites</a></li>
<li><a href="#_tilt_development_environment">2.2. Tilt development environment</a></li>
<li><a href="#_development_using_kind_or_minikube">2.3. Development using Kind or Minikube</a></li>
</ul>
</li>
<li><a href="#_api_and_resource_definitions">3. API and Resource Definitions</a>
<ul class="sectlevel2">
<li><a href="#_baremetalhost">3.1. BareMetalHost</a></li>
<li><a href="#_cluster">3.2. Cluster</a></li>
<li><a href="#_metal3cluster">3.3. Metal3Cluster</a></li>
<li><a href="#_kubeadmcontrolplane">3.4. KubeadmControlPlane</a></li>
<li><a href="#_kubeadmconfig">3.5. KubeadmConfig</a></li>
<li><a href="#_machine">3.6. Machine</a></li>
<li><a href="#_metal3machine">3.7. Metal3Machine</a></li>
<li><a href="#_machinedeployment">3.8. MachineDeployment</a></li>
<li><a href="#_kubeadmconfigtemplate">3.9. KubeadmConfigTemplate</a></li>
<li><a href="#_metal3machinetemplate">3.10. Metal3MachineTemplate</a></li>
<li><a href="#_metal3datatemplate">3.11. Metal3DataTemplate</a></li>
<li><a href="#_the_metal3dataclaim_object">3.12. The Metal3DataClaim object</a></li>
<li><a href="#_the_metal3data_object">3.13. The Metal3Data object</a></li>
<li><a href="#_deployment_flow">3.14. Deployment flow</a></li>
<li><a href="#_metal3_dev_env_examples">3.15. Metal3 dev env examples</a></li>
</ul>
</li>
<li><a href="#_capm3_testing">4. CAPM3 testing</a>
<ul class="sectlevel2">
<li><a href="#_code_coverage">4.1. Code coverage</a></li>
<li><a href="#_testing_files">4.2. Testing files</a></li>
<li><a href="#_mocking">4.3. Mocking</a></li>
<li><a href="#_testing_guidelines">4.4. Testing Guidelines</a></li>
</ul>
</li>
<li><a href="#_deployment_workflow">5. Deployment workflow</a>
<ul class="sectlevel2">
<li><a href="#_deploying_the_controllers">5.1. Deploying the controllers</a></li>
<li><a href="#_requirements_2">5.2. Requirements</a></li>
<li><a href="#_deploying_the_crs">5.3. Deploying the CRs</a></li>
<li><a href="#_deletion">5.4. Deletion</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_cluster_api_provider_metal">1. Cluster API provider Metal³</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This provider integrates with the
<a href="https://github.com/kubernetes-sigs/cluster-api">Cluster API project</a>.</p>
</div>
<div class="sect2">
<h3 id="_setup">1.1. Setup</h3>
<div class="sect3">
<h4 id="_pre_requisites">1.1.1. Pre-requisites</h4>
<div class="paragraph">
<p>The pre-requisite for the deployment of CAPM3 are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ironic up and running (inside or outside of the cluster)</p>
</li>
<li>
<p>BareMetalHost resources created for all hardware nodes and in "ready"
or "available" state</p>
</li>
<li>
<p>all cluster-related CRs (inc. BareMetalHosts and related) must be in
the same namespace. This is due to the use of owner references.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_using_clusterctl">1.1.2. Using clusterctl</h4>
<div class="paragraph">
<p>Please refer to
<a href="https://master.cluster-api.sigs.k8s.io/clusterctl/overview.html">Clusterctl
documentation</a>. Once the <a href="#pre-requisites">Pre-requisites</a> are
fulfilled, you can follow the normal clusterctl flow for the <code>init</code>,
<code>config</code>, <code>upgrade</code>, <code>move</code> and <code>delete</code> workflow. Please refer to the
<a href="#pivoting-or-updating-ironic">Pivoting Ironic</a> section for
additional information on the <code>move</code> process.</p>
</div>
<div class="sect4">
<h5 id="_environment_variables">Environment variables</h5>
<div class="paragraph">
<p>There are some required variables :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DEPLOY_KERNEL_URL</p>
</li>
<li>
<p>DEPLOY_RAMDISK_URL</p>
</li>
<li>
<p>IRONIC_URL</p>
</li>
<li>
<p>IRONIC_INSPECTOR_URL</p>
</li>
<li>
<p>IRONIC_CA_CERT_B64 <strong>or</strong> IRONIC_NO_CA_CERT</p>
</li>
<li>
<p>IRONIC_NO_BASIC_AUTH <strong>or</strong> IRONIC_USERNAME and IRONIC_PASSWORD</p>
</li>
<li>
<p>IRONIC_INSPECTOR_NO_BASIC_AUTH <strong>or</strong> IRONIC_INSPECTOR_USERNAME and
IRONIC_INSPECTOR_PASSWORD</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_deploy_kernel_url">DEPLOY_KERNEL_URL</h6>
<div class="paragraph">
<p>This is the URL of the kernel to deploy. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export DEPLOY_KERNEL_URL="http://172.22.0.1:6180/images/ironic-python-agent.kernel"`</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_deploy_ramdisk_url">DEPLOY_RAMDISK_URL</h6>
<div class="paragraph">
<p>This is the URL of the ramdisk to deploy. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export DEPLOY_RAMDISK_URL="http://172.22.0.1:6180/images/ironic-python-agent.initramfs"`</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_url">IRONIC_URL</h6>
<div class="paragraph">
<p>This is the URL of the ironic endpoint. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_URL="http://172.22.0.1:6385/v1/"`</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_inspector_url">IRONIC_INSPECTOR_URL</h6>
<div class="paragraph">
<p>This is the URL of the ironic inspector endpoint. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_INSPECTOR_URL="http://172.22.0.1:5050/v1/"`</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_ca_cert_b64">IRONIC_CA_CERT_B64</h6>
<div class="paragraph">
<p>This contains the CA certificate for Ironic, encoded in Base 64. It
defaults to an empty string in case you do not want to provide a CA
certificate. Setting this variable is optional, but either this variable
or <code>IRONIC_NO_CA_CERT</code> must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_CA_CERT_B64="LS0tLS1C..."</code></pre>
</div>
</div>
<div class="paragraph">
<p>The content of this variable must be string without line wraps. It can
be generated as follows :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_CA_CERT_B64="$(cat ca.crt | base64 -w 0)"</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_no_ca_cert">IRONIC_NO_CA_CERT</h6>
<div class="paragraph">
<p>Do not use a dedicated CA certificate for Ironic API. Any value provided
in this variable disables additional CA certificate validation. To
provide a CA certificate, leave this variable unset. If unset, then
<code>IRONIC_CA_CERT_B64</code> must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_NO_CA_CERT="true"</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_username">IRONIC_USERNAME</h6>
<div class="paragraph">
<p>Username for Ironic basic auth. Optional, but either this variable or
<code>IRONIC_NO_BASIC_AUTH</code> must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_USERNAME="&lt;username&gt;"</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_password">IRONIC_PASSWORD</h6>
<div class="paragraph">
<p>Password for Ironic basic auth. Optional, but either this variable or
<code>IRONIC_NO_BASIC_AUTH</code> must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_PASSWORD="&lt;password&gt;"</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_no_basic_auth">IRONIC_NO_BASIC_AUTH</h6>
<div class="paragraph">
<p>Disables basic authentication for Ironic API. Any value provided in this
variable disables authentication. To enable authentication, leave this
variable unset. If unset, then <code>IRONIC_USERNAME</code> and <code>IRONIC_PASSWORD</code>
must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_NO_BASIC_AUTH="true"</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_inspector_username">IRONIC_INSPECTOR_USERNAME</h6>
<div class="paragraph">
<p>Username for Ironic inspector basic auth. Optional, but either this
variable or <code>IRONIC_INSPECTOR_NO_BASIC_AUTH</code> must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_INSPECTOR_USERNAME="&lt;username&gt;"</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_inspector_password">IRONIC_INSPECTOR_PASSWORD</h6>
<div class="paragraph">
<p>Password for Ironic inspector basic auth. Optional, but either this
variable or <code>IRONIC_INSPECTOR_NO_BASIC_AUTH</code> must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_INSPECTOR_PASSWORD="&lt;password&gt;"</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ironic_inspector_no_basic_auth">IRONIC_INSPECTOR_NO_BASIC_AUTH</h6>
<div class="paragraph">
<p>Disables basic authentication for Ironic inspector API. Any value
provided in this variable disables authentication. To enable
authentication, leave this variable unset. If unset, then
<code>IRONIC_INSPECTOR_USERNAME</code> and <code>IRONIC_INSPECTOR_PASSWORD</code> must be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">  export IRONIC_INSPECTOR_NO_BASIC_AUTH="true"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_cluster_templates_variables">Cluster templates variables</h5>
<div class="paragraph">
<p>CAPM3 provides a cluster template. This requires some environment
variables properly set. You can find an example file containing the
environment variables `example_variables.rc`in the release or
<a href="https://github.com/metal3-io/cluster-api-provider-metal3/tree/master/examples/clusterctl-templates/example_variables.rc">here</a>.
The examples provided there or below assume that you are deploying the
target node using an off-the-shelf Ubuntu image (18.04), served locally
in the metal3-dev-env. They must be adapted for any deployment.</p>
</div>
</div>
<div class="sect4">
<h5 id="_pod_cidr">POD_CIDR</h5>
<div class="paragraph">
<p>This is the CIDR for the pod. It can be given as a comma separated list
of quoted elements. For example:</p>
</div>
<div class="paragraph">
<p><code>POD_CIDR='"192.168.0.0/24", "192.168.1.0/24"'</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_service_cidr">SERVICE_CIDR</h5>
<div class="paragraph">
<p>This is the CIDR for the services. It can be given as a comma separated
list of quoted elements. For example:</p>
</div>
<div class="paragraph">
<p><code>SERVICE_CIDR='"192.168.2.0/24", "192.168.3.0/24"'</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_api_endpoint_host">API_ENDPOINT_HOST</h5>
<div class="paragraph">
<p>This is the API endpoint name or IP address. For example:</p>
</div>
<div class="paragraph">
<p><code>API_ENDPOINT_HOST="192.168.111.249"</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_api_endpoint_port">API_ENDPOINT_PORT</h5>
<div class="paragraph">
<p>This is the API endpoint port. For example:</p>
</div>
<div class="paragraph">
<p><code>API_ENDPOINT_PORT="6443"</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_image_url">IMAGE_URL</h5>
<div class="paragraph">
<p>This is the URL of the image to deploy. It should be a qcow2 image. For
example:</p>
</div>
<div class="paragraph">
<p><code>IMAGE_URL="http://192.168.0.1/ubuntu.qcow2"</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_image_checksum">IMAGE_CHECKSUM</h5>
<div class="paragraph">
<p>This is the URL of the md5sum of the image to deploy. For example:</p>
</div>
<div class="paragraph">
<p><code>IMAGE_CHECKSUM="http://192.168.0.1/ubuntu.qcow2.md5sum"</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_ctlplane_kubeadm_extra_config">CTLPLANE_KUBEADM_EXTRA_CONFIG</h5>
<div class="paragraph">
<p>This contains the extra configuration to pass in KubeadmControlPlane. It
is critical to maintain the indentation. The allowed keys are :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>preKubeadmCommands</p>
</li>
<li>
<p>postKubeadmCommands</p>
</li>
<li>
<p>files</p>
</li>
<li>
<p>users</p>
</li>
<li>
<p>ntp</p>
</li>
<li>
<p>format</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example for Ubuntu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">CTLPLANE_KUBEADM_EXTRA_CONFIG="
    preKubeadmCommands:
      - ip link set dev enp2s0 up
      - dhclient enp2s0
      - apt update -y
      - netplan apply
      - &gt;-
        apt install net-tools gcc linux-headers-$(uname -r) bridge-utils
        apt-transport-https ca-certificates curl gnupg-agent
        software-properties-common -y
      - apt install -y keepalived &amp;&amp; systemctl stop keepalived
      - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
      - add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"
      - curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
      - echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main' &gt; /etc/apt/sources.list.d/kubernetes.list
      - apt update -y
      - apt install docker-ce docker-ce-cli containerd.io kubelet kubeadm kubectl -y
      - systemctl enable --now docker kubelet
      - if (curl -sk --max-time 10 https://{{ CLUSTER_APIENDPOINT_HOST }}:6443/healthz); then echo \"keepalived already running\";else systemctl start keepalived; fi
      - usermod -aG docker ubuntu
    postKubeadmCommands:
      - mkdir -p /home/ubuntu/.kube
      - cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
      - systemctl enable --now keepalived
      - chown ubuntu:ubuntu /home/ubuntu/.kube/config
    files:
        - path: /etc/keepalived/keepalived.conf
          content: |
            ! Configuration File for keepalived
            global_defs {
                notification_email {
                sysadmin@example.com
                support@example.com
                }
                notification_email_from lb@example.com
                smtp_server localhost
                smtp_connect_timeout 30
            }
            vrrp_instance VI_2 {
                state MASTER
                interface enp2s0
                virtual_router_id 2
                priority 101
                advert_int 1
                virtual_ipaddress {
                    {{ CLUSTER_APIENDPOINT_HOST }}
                }
            }
        - path: /etc/netplan/50-cloud-init.yaml
          owner: root:root
          permissions: '0644'
          content: |
            network:
                ethernets:
                    enp2s0:
                        dhcp4: true
                version: 2
        - path : /etc/netplan/60-ironicendpoint.yaml
          owner: root:root
          permissions: '0644'
          content: |
            network:
              version: 2
              renderer: networkd
              bridges:
                ironicendpoint:
                  interfaces: [enp1s0]
                  dhcp4: yes
"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_workers_kubeadm_extra_config">WORKERS_KUBEADM_EXTRA_CONFIG</h5>
<div class="paragraph">
<p>This contains the extra configuration to pass in KubeadmConfig for
workers. It is critical to maintain the indentation. The allowed keys
are :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>preKubeadmCommands</p>
</li>
<li>
<p>postKubeadmCommands</p>
</li>
<li>
<p>files</p>
</li>
<li>
<p>users</p>
</li>
<li>
<p>ntp</p>
</li>
<li>
<p>format</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example for Ubuntu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">WORKERS_KUBEADM_EXTRA_CONFIG="
      preKubeadmCommands:
        - ip link set dev enp2s0 up
        - dhclient enp2s0
        - apt update -y
        - netplan apply
        - &gt;-
          apt install apt-transport-https ca-certificates
          curl gnupg-agent software-properties-common -y
        - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        - add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"
        - curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
        - echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main' &gt; /etc/apt/sources.list.d/kubernetes.list
        - apt update -y
        - apt install docker-ce docker-ce-cli containerd.io kubelet kubeadm kubectl -y
        - systemctl enable --now docker kubelet
        - usermod -aG docker ubuntu
      files:
        - path: /etc/netplan/50-cloud-init.yaml
          owner: root:root
          permissions: '0644'
          content: |
            network:
                ethernets:
                    enp1s0:
                        dhcp4: true
                    enp2s0:
                        dhcp4: true
                version: 2
"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pivoting_or_updating_ironic">1.2. Pivoting or updating Ironic</h3>
<div class="paragraph">
<p>Before running the <code>move</code> command of Clusterctl, elements such as Ironic
if applicable, need to be moved to the target cluster. It is recommended
to scale down the ironic pod in the origin cluster before deploying it
on the target cluster to prevent issues with a duplicated DHCP server.</p>
</div>
<div class="paragraph">
<p>Both for pivoting or updating ironic, it is critical that the cluster is
in a stable situation. No operations on BareMetal hosts shall be
on-going, otherwise they might fail. Similarly, in order to prevent
conflict during the pivoting of the DHCP server, we recommend to have no
BareMetalHosts running IPA (in <code>ready</code> state with <code>fasttrack</code> option
enabled) during the the pivoting. It could otherwise result in IP
address conflicts or changes of the IP address of a running host that
would not be supported by Ironic.</p>
</div>
<div class="paragraph">
<p>In the case of a self-hosted cluster, special care must be paid to
Ironic. Since Ironic runs on the target cluster, updating the target
cluster means that ironic will need to be moved between nodes of the
cluster. This results in similar issues as pivoting. The following
points should be ensured to run a target cluster upgrade:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>no unnecessary hosts are running IPA during the upgrade to limit the
amount of conflicts</p>
</li>
<li>
<p>When upgrading the K8S node or group of nodes that run Ironic
currently, only one node at a time should be upgraded, and no other
parallel upgrade operations should be happening.</p>
</li>
<li>
<p>All nodes that are hosting Ironic or have connectivity to the
provisioning network must be using a static IP address. If not, Ironic
might not come up since Keepalived will not be starting. In addition, if
using DHCP, conflicts could happen. We highly recommend that ALL nodes
with connectivity to the provisioning network are using static IP
addresses, using Metal3DataTemplates for example.</p>
</li>
<li>
<p>Ironic should always be the first component upgraded, before a CAPM3 /
BMO upgrade using clusterctl for example, or before nodes upgrades. This
is to ensure that the cluster is in a stable condition while upgrading
Ironic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Important Note:</strong> Currently, when target cluster is up and node appears,
CAPM3 will fetch the node and set the providerID value to BMH UUID,
meaning that it is not advisable to directly map the K.Node &#8592;-&#8594; BMH
after pivoting. However, if needed, we can still find the providerID
value in Metal3Machine Spec. which enables us to do the mapping with an
intermediary step, i.e K.Node &#8592;&#8594; M3Machine &#8592;&#8594; BMH.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_a_development_environment">2. Setting up a development environment</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_pre_requisites_2">2.1. Pre-requisites</h3>
<div class="paragraph">
<p>CAPM3 requires two external tools for running the tests during
development.</p>
</div>
<div class="sect3">
<h4 id="_install_kustomize">2.1.1. Install kustomize</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./hack/tools/install_kustomize.sh</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_kubebuilder">2.1.2. Install kubebuilder</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./hack/tools/install_kubebuilder.sh</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tilt_development_environment">2.2. Tilt development environment</h3>
<div class="paragraph">
<p>Both of the <a href="https://tilt.dev">Tilt</a> setups below will get you started
developing CAPM3 in a local kind cluster. The main difference is the
number of components you will build from source and the scope of the
changes you&#8217;d like to make. If you only want to make changes in CAPM3,
then follow <a href="#tilt-for-dev-in-capm3">CAPM3 instructions</a>. This will
save you from having to build all of the images for CAPI, which can take
a while. If the scope of your development will span both CAPM3 and CAPI,
then follow the <a href="#tilt-for-dev-in-both-capm3-and-capi">CAPI and CAPM3
instructions</a>.</p>
</div>
<div class="sect3">
<h4 id="_tilt_for_dev_in_capm3">2.2.1. Tilt for dev in CAPM3</h4>
<div class="paragraph">
<p>In order to develop CAPM3 using Tilt, there is a requirement to have
kind and Tilt installed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    hack/ensure-kind.sh
    curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once installed, you will need a tilt-settings.json. You can generate one
using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    make tilt-settings</code></pre>
</div>
</div>
<div class="paragraph">
<p>This requires the following environment variables to be exported :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DEPLOY_KERNEL_URL</code></p>
</li>
<li>
<p><code>DEPLOY_RAMDISK_URL</code></p>
</li>
<li>
<p><code>IRONIC_INSPECTOR_URL</code></p>
</li>
<li>
<p><code>IRONIC_URL</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those need to be set up accordingly with the
<a href="https://github.com/metal3-io/baremetal-operator/blob/master/docs/dev-setup.md#running-a-local-instance-of-ironic">local
ironic setup</a></p>
</div>
<div class="paragraph">
<p>The tilt-settings file can be customized. Tilt will also consider
everything under <code>tilt.d</code> directory.</p>
</div>
<div class="paragraph">
<p>Then start Tilt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    make tilt-up</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changes in the go code will trigger an update of the images running to
run the latest code of CAPM3.</p>
</div>
<div class="paragraph">
<p>Tilt can be used in Metal3-dev-env, as long as the
03_launch_mgmt_cluster.sh script is <strong>NOT</strong> run. In that case Ironic needs
to be deployed locally first, following the
<a href="https://github.com/metal3-io/baremetal-operator/blob/master/docs/dev-setup.md#running-a-local-instance-of-ironic">local
ironic setup</a></p>
</div>
<div class="paragraph">
<p>By default, the Cluster API components deployed by Tilt have
experimental features turned off. If you would like to enable these
features, add <code>extra_args</code> as specified in
<a href="https://cluster-api.sigs.k8s.io/developer/tilt.html#create-a-tilt-settingsjson-file">The
Cluster API Book</a>.</p>
</div>
<div class="paragraph">
<p>Once your kind management cluster is up and running, you can
<a href="#deploying-an-example-cluster">deploy an example cluster</a>.</p>
</div>
<div class="paragraph">
<p>You can also <a href="#Running-flavor-clusters-as-a-tilt-resource">deploy a
flavor cluster as a local tilt resource</a>.</p>
</div>
<div class="paragraph">
<p>To tear down the kind cluster built by the command above, just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">make kind-reset</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tilt_for_dev_in_both_capm3_and_capi">2.2.2. Tilt for dev in both CAPM3 and CAPI</h4>
<div class="paragraph">
<p>If you want to develop in both CAPI and CAPM3 at the same time, then
this is the path for you.</p>
</div>
<div class="paragraph">
<p>First, you will need a kind setup with a registry. You can use the
following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    make kind-create</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use <a href="https://tilt.dev/">Tilt</a> for a simplified development workflow,
follow the
<a href="https://cluster-api.sigs.k8s.io/developer/tilt.html">instructions</a> in the
cluster API repo. The instructions will walk you through cloning the
Cluster API (CAPI) repository and configuring Tilt to use <code>kind</code> to
deploy the cluster api management components.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>you may wish to checkout out the correct version of CAPI to match the
<a href="go.mod">version used in CAPM3</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Note that <code>tilt up</code> will be run from the <code>cluster-api repository</code>
directory and the <code>tilt-settings.json</code> file will point back to the
<code>cluster-api-provider-metal3</code> repository directory. Any changes you make
to the source code in <code>cluster-api</code> or <code>cluster-api-provider-metal3</code>
repositories will automatically redeployed to the <code>kind</code> cluster.</p>
</div>
<div class="paragraph">
<p>After you have cloned both repositories, your folder structure should
look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tree" data-lang="tree">|-- src/cluster-api-provider-metal3
|-- src/cluster-api (run `tilt up` here)</code></pre>
</div>
</div>
<div class="paragraph">
<p>After configuring the environment variables, run the following to
generate your <code>tilt-settings.json</code> file in the cluster API repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">cat &lt;&lt;EOF &gt; tilt-settings.json
{
    "allowed_contexts": ["kind-capm3"],
    "deploy_cert_manager": True,
    "preload_images_for_kind": True,
    "kind_cluster_name": "capm3",
    "provider_repos": ["../cluster-api-provider-metal3"],
    "enable_providers": ["metal3", "docker", "kubeadm-bootstrap", "kubeadm-control-plane"],
    "kustomize_substitutions": {
        "DEPLOY_KERNEL_URL": "${DEPLOY_KERNEL_URL}",
        "DEPLOY_RAMDISK_URL": "${DEPLOY_RAMDISK_URL}",
        "IRONIC_INSPECTOR_URL": "${IRONIC_INSPECTOR_URL}",
        "IRONIC_URL": ${IRONIC_URL}"
  }
}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>This requires the following environment variables to be exported :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DEPLOY_KERNEL_URL</code></p>
</li>
<li>
<p><code>DEPLOY_RAMDISK_URL</code></p>
</li>
<li>
<p><code>IRONIC_INSPECTOR_URL</code></p>
</li>
<li>
<p><code>IRONIC_URL</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those need to be set up accordingly with the
<a href="https://github.com/metal3-io/baremetal-operator/blob/master/docs/dev-setup.md#running-a-local-instance-of-ironic">local
ironic setup</a></p>
</div>
<div class="paragraph">
<p>The cluster-api management components that are deployed are configured
at the <code>/config</code> folder of each repository respectively. Making changes
to those files will trigger a redeploy of the management cluster
components.</p>
</div>
</div>
<div class="sect3">
<h4 id="_including_baremetal_operator_and_ip_address_manager">2.2.3. Including Baremetal Operator and IP Address Manager</h4>
<div class="paragraph">
<p>If you want to develop on Baremetal Operator or IP Address Manager
repository you can include them. First you need to clone the
repositories you intend to modify locally, then modify your
tilt-settings.json to point to the correct repositories. In case you
have a tree like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#-|
# |- cluster-api
# |- cluster-api-provider-metal3
# |- baremetal-operator
# |- ip-address-manager</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you create your <code>tilt-settings.json</code> in the ./cluster-api or in the
./cluster-api-provider-metal3 folder. Then your tilt-settings.json file
would be :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "provider_repos": [ ... , "../baremetal-operator", "../metal3-ipam"],
  "enable_providers": [ ... , "metal3-bmo", "metal3-ipam"],
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The provider name for Baremetal Operator is <code>metal3-bmo</code> and for IP
Address Manager <code>metal3-ipam</code>. Those names are defined in their
respective repository.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In case you are modifying the manifests for BMO or IPAM, then you should
also modify the <code>kustomization.yaml</code> files in <code>./config/bmo</code> and
<code>./config/ipam</code> to refer to the modified manifests locally instead of
downloading released ones.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="_running_flavor_clusters_as_a_tilt_resource">2.2.4. Running flavor clusters as a tilt resource</h4>
<div class="paragraph">
<p>For a successful deployment, you need to have exported the proper
variables. You can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    source ./examples/clusterctl-templates/example_variables.rc</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the example variables do not guarantee a successful deployment,
they need to be adapted. If deploying on Metal3-dev-env, please rather
use the Metal3-dev-env deployment scripts that are tailored for it.</p>
</div>
<div class="sect4">
<h5 id="_from_cli">From CLI</h5>
<div class="paragraph">
<p>run <code>tilt up ${flavors}</code> to spin up worker clusters represented by a
Tilt local resource. You can also modify flavors while Tilt is up by
running <code>tilt args ${flavors}</code></p>
</div>
</div>
<div class="sect4">
<h5 id="_from_tilt_config">From Tilt Config</h5>
<div class="paragraph">
<p>Add your desired flavors to tilt_config.json:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "worker-flavors": ["default"]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_requirements">Requirements</h5>
<div class="paragraph">
<p>Please note your tilt-settings.json must contain at minimum the
following fields when using tilt resources to deploy cluster flavors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "kustomize_substitutions": {
    "DEPLOY_KERNEL_URL": "...",
    "DEPLOY_RAMDISK_URL": "...",
    "IRONIC_INSPECTOR_URL": "...",
    "IRONIC_URL": "..."
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_defining_variable_overrides">Defining Variable Overrides</h5>
<div class="paragraph">
<p>If you wish to override the default variables for flavor workers, you
can specify them as part of your tilt-settings.json as seen in the
example below. Please note, the precedence of variables is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>explicitly defined vars for each flavor i.e.
<code>worker-templates.flavors[0].WORKER_MACHINE_COUNT</code></p>
</li>
<li>
<p>vars defined at 'metadata' level-- spans workers i.e.
<code>metadata.WORKER_MACHINE_COUNT</code></p>
</li>
<li>
<p>programmatically defined default vars i.e. everything except ironic
related URL variables "DEPLOY_KERNEL_URL", "DEPLOY_RAMDISK_URL",
"IRONIC_INSPECTOR_URL" and "IRONIC_URL"</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "kustomize_substitutions": {
        "DEPLOY_KERNEL_URL": "...",
        "DEPLOY_RAMDISK_URL": "...",
        "IRONIC_INSPECTOR_URL": "...",
        "IRONIC_URL": "..."
    },
    "worker-templates": {
        "flavors": {
            "default": {
                "CLUSTER_NAME": "example-default-cluster-name",
            }
        },
        "metadata": {,
            "CONTROL_PLANE_MACHINE_COUNT": "1",
            "KUBERNETES_VERSION": "v1.18.8",
            "WORKER_MACHINE_COUNT": "2",
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_development_using_kind_or_minikube">2.3. Development using Kind or Minikube</h3>
<div class="paragraph">
<p>See the <a href="https://kind.sigs.k8s.io/docs/user/quick-start">Kind docs</a> for
instructions on launching a Kind cluster and the
<a href="https://kubernetes.io/docs/setup/minikube/">Minikube docs</a> for
instructions on launching a Minikube cluster.</p>
</div>
<div class="sect3">
<h4 id="_deploy_capi_and_capm3">2.3.1. Deploy CAPI and CAPM3</h4>
<div class="paragraph">
<p>The following command will deploy the controllers from CAPI, CABPK and
CAPM3 and the requested CRDs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    make deploy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_the_controller_locally">2.3.2. Run the Controller locally</h4>
<div class="paragraph">
<p>You will first need to scale down the controller deployment :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    kubectl scale -n capm3-system deployment.v1.apps/capm3-controller-manager \
      --replicas 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can manually run the controller from outside of the cluster for
development and testing purposes. There’s a <code>Makefile</code> target which
makes this easy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">make run</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can follow the output on the console to see information about what
the controller is doing. You can also proceed to create/update/delete
<code>Metal3Machines</code> and <code>BareMetalHosts</code> to test the controller logic.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deploy_an_example_cluster">2.3.3. Deploy an example cluster</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    make deploy-examples</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_delete_the_example_cluster">2.3.4. Delete the example cluster</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">    make delete-examples</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_and_resource_definitions">3. API and Resource Definitions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This describes a setup where the following Cluster API core components
and Metal3-io components are deployed :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster API manager</p>
</li>
<li>
<p>Cluster API Bootstrap Provider Kubeadm (CABPK) manager</p>
</li>
<li>
<p>Cluster API Kubeadm Control Plane manager</p>
</li>
<li>
<p>Baremetal Operator (including the Ironic setup)</p>
</li>
<li>
<p>Cluster API Provider Metal3 (CAPM3)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_baremetalhost">3.1. BareMetalHost</h3>
<div class="paragraph">
<p>The BareMetalHost is an object from
<a href="https://github.com/metal3-io/baremetal-operator">baremetal-operator</a>.
Each CR represents a physical host with BMC credentials, hardware status
etc.</p>
</div>
<div class="paragraph">
<p>BareMetalHost exposes those different fields that are secret references:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>userData</strong> : for a cloud-init user-data in a secret with the key
<code>userData</code></p>
</li>
<li>
<p><strong>metaData</strong> : for a cloud-init metadata in a secret with the key
<code>metaData</code></p>
</li>
<li>
<p><strong>networkData</strong> : for a cloud-init network data in a secret with the key
<code>networkData</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the metaData, soome values are set by default to maintain
compatibility:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>uuid</strong>: This is the BareMetalHost UID</p>
</li>
<li>
<p><strong>metal3-namespace</strong>: the name of the BareMetalHost</p>
</li>
<li>
<p><strong>metal3-name</strong>: The name of the BareMetalHost</p>
</li>
<li>
<p><strong>local-hostname</strong>: The name of the BareMetalHost</p>
</li>
<li>
<p><strong>local_hostname</strong>: The namespace of the BareMetalHost</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, setting any of those values in the metaData secret will
override those default values.</p>
</div>
<div class="sect3">
<h4 id="_unhealthy_annotation">3.1.1. Unhealthy annotation</h4>
<div class="paragraph">
<p>In CAPM3 v1alpha4 it is possible to mark BareMetalHost object as
unhealthy by adding an annotation <code>capi.metal3.io/unhealthy</code>. This
annotation prevents CAPM3 to select unhealthy BareMetalHost for newly
created metal3machine. Removing the annotation will enable the normal
operations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cluster">3.2. Cluster</h3>
<div class="paragraph">
<p>A Cluster is a Cluster API core object representing a Kubernetes
cluster.</p>
</div>
<div class="paragraph">
<p>Example cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: Cluster
metadata:
  name: cluster
spec:
  clusterNetwork:
    services:
      cidrBlocks: ["10.96.0.0/12"]
    pods:
      cidrBlocks: ["192.168.0.0/18"]
    serviceDomain: "cluster.local"
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    kind: Metal3Cluster
    name: m3cluster
  controlPlaneRef:
    kind: KubeadmControlPlane
    apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
    name: m3cluster-controlplane</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metal3cluster">3.3. Metal3Cluster</h3>
<div class="paragraph">
<p>The metal3Cluster object contains information related to the deployment
of the cluster on Baremetal. It currently has two specification fields :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>controlPlaneEndpoint</strong>: contains the target cluster API server address
and port</p>
</li>
<li>
<p><strong>noCloudProvider</strong>: (true/false) Whether the cluster will not be
deployed with an external cloud provider. If set to true, CAPM3 will
patch the target cluster node objects to add a providerID. This will
allow the CAPI process to continue even if the cluster is deployed
without cloud provider.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example metal3cluster :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Cluster
metadata:
  name: m3cluster
spec:
 controlPlaneEndpoint:
   host: 192.168.111.249
   port: 6443
 noCloudProvider: true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kubeadmcontrolplane">3.4. KubeadmControlPlane</h3>
<div class="paragraph">
<p>This object contains all information related to the control plane
configuration. It references an <strong>infrastructureTemplate</strong> that must be a
<em>Metal3MachineTemplate</em> in this case.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">kind: KubeadmControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
metadata:
  name: m3cluster-controlplane
spec:
  replicas: 3
  version: v1.17.0
  infrastructureTemplate:
    kind: Metal3MachineTemplate
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    name: m3cluster-controlplane
  kubeadmConfigSpec:
    initConfiguration:
      nodeRegistration:
        name: 'host0'
        kubeletExtraArgs:
          cloud-provider: baremetal
    clusterConfiguration:
      apiServer:
        extraArgs:
          cloud-provider: baremetal
      controllerManager:
        extraArgs:
          cloud-provider: baremetal
    joinConfiguration:
      controlPlane: {}
      nodeRegistration:
        name: 'host0'
        kubeletExtraArgs:
          cloud-provider: baremetal</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kubeadmconfig">3.5. KubeadmConfig</h3>
<div class="paragraph">
<p>The KubeadmConfig object is for CABPK. It contains the node Kubeadm
configuration and additional commands to run on the node for the setup.</p>
</div>
<div class="paragraph">
<p>In order to deploy Kubernetes successfully, you need to know the cluster
API address before deployment. However, if you are deploying an HA
cluster or if you are deploying without using static ip addresses, the
cluster API server address is unknown. A solution to go around the
problem is to deploy Keepalived. Keepalived allows you to set up a
virtual IP, defined beforehand, and shared by the nodes. Hence the
commands to set up Keepalived have to run before kubeadm.</p>
</div>
<div class="paragraph">
<p>The content of a KubeadmConfig can contain Jinja2 template elements,
since the cloud-init renders the cloud-config as a Jinja2 template. It
is possible to use metadata from cloud-init, using the following:
<code>{{ ds.meta_data.&lt;key&gt;}}</code>. The keys and values are passed to cloud-init
through a <code>Metal3DataTemplate</code> object (see below).</p>
</div>
<div class="paragraph">
<p>Example KubeadmConfig:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: KubeadmConfig
metadata:
  name: controlplane-0
spec:
  initConfiguration:
    nodeRegistration:
      name: '{{ ds.meta_data.name }}'
      kubeletExtraArgs:
        node-labels: 'metal3.io/uuid={{ ds.meta_data.uuid }}'
  preKubeadmCommands:
    - apt update -y
    - apt install net-tools -y
    - apt install -y gcc linux-headers-$(uname -r)
    - apt install -y keepalived
    - systemctl start keepalived
    - systemctl enable keepalived
    - &gt;-
      apt install apt-transport-https ca-certificates curl gnupg-agent
      software-properties-common -y
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
    - &gt;-
      add-apt-repository "deb [arch=amd64]
      https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    - apt update -y
    - apt install docker-ce docker-ce-cli containerd.io -y
    - usermod -aG docker ubuntu
    - &gt;-
      curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg
      | apt-key add -
    - &gt;-
      echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main'
      &gt; /etc/apt/sources.list.d/kubernetes.list
    - apt update
    - apt install -y kubelet kubeadm kubectl
    - systemctl enable --now kubelet
  postKubeadmCommands:
    - mkdir -p /home/ubuntu/.kube
    - cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    - chown ubuntu:ubuntu /home/ubuntu/.kube/config
  files:
      - path: /etc/keepalived/keepalived.conf
        content: |
          ! Configuration File for keepalived
          global_defs {
              notification_email {
              sysadmin@example.com
              support@example.com
              }
              notification_email_from lb@example.com
              smtp_server localhost
              smtp_connect_timeout 30
          }
          vrrp_instance VI_1 {
              state MASTER
              interface enp2s0
              virtual_router_id 1
              priority 101
              advert_int 1
              virtual_ipaddress {
                  192.168.111.249
              }
          }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_machine">3.6. Machine</h3>
<div class="paragraph">
<p>A Machine is a Cluster API core object representing a Kubernetes node. A
machine has a reference to a KubeadmConfig and a reference to a
metal3machine.</p>
</div>
<div class="paragraph">
<p>Example Machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: Machine
metadata:
  name: controlplane-0
  labels:
    cluster.x-k8s.io/control-plane: "true"
    cluster.x-k8s.io/cluster-name: "cluster"
spec:
  version: 1.16
  bootstrap:
    configRef:
      apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
      kind: KubeadmConfig
      name: controlplane-0
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    kind: Metal3Machine
    name: controlplane-0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metal3machine">3.7. Metal3Machine</h3>
<div class="paragraph">
<p>The Metal3Machine contains information related to the deployment of the
BareMetalHost such as the image and the host selector. For each machine,
there must be a Metal3Machine.</p>
</div>
<div class="paragraph">
<p>The fields are :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>image</strong>&#8201;&#8212;&#8201;This includes two sub-fields, <code>url</code> and <code>checksum</code>, which
include the URL to the image and the URL to a checksum for that image.
These fields are required. The image will be used for provisioning of
the <code>BareMetalHost</code> chosen by the <code>Machine</code> actuator.</p>
</li>
<li>
<p><strong>userData</strong>&#8201;&#8212;&#8201;This includes two sub-fields, <code>name</code> and <code>namespace</code>,
which reference a <code>Secret</code> that contains base64 encoded user-data to be
written to a config drive on the provisioned <code>BareMetalHost</code>. This field
is optional and is automatically set by CAPM3 with the userData from the
machine object. If you want to overwrite the userData, this should be
done in the CAPI machine.</p>
</li>
<li>
<p><strong>dataTemplate</strong>&#8201;&#8212;&#8201;This includes a reference to a Metal3DataTemplate
object containing the metadata and network data templates, and includes
two fields, <code>name</code> and <code>namespace</code>.</p>
</li>
<li>
<p><strong>metaData</strong> is a reference to a secret containing the metadata rendered
from the Metal3DataTemplate metadata template object automatically. In
case this would not be managed by the Metal3DataTemplate controller, if
provided by the user for example, the ownerreference should be set
properly to ensure that the secret belongs to the cluster ownerReference
tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).</p>
</li>
<li>
<p><strong>networkData</strong> is a reference to a secret containing the network data
rendered from the Metal3DataTemplate metadata template object
automatically. In case this would not be managed by the
Metal3DataTemplate controller, if provided by the user for example, the
ownerreference should be set properly to ensure that the secret belongs
to the cluster ownerReference tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).
The content of the secret should be a yaml equivalent of a json object
that follows the format definition that can be found
<a href="https://docs.openstack.org/nova/latest/_downloads/9119ca7ac90aa2990e762c08baea3a36/network_data.json">here</a>.</p>
</li>
<li>
<p><strong>hostSelector</strong>&#8201;&#8212;&#8201;Specify criteria for matching labels on
<code>BareMetalHost</code> objects. This can be used to limit the set of available
<code>BareMetalHost</code> objects chosen for this <code>Machine</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>metaData</code> and <code>networkData</code> field in the <code>spec</code> section are for the
user to give directly a secret to use as metaData or networkData. The
<code>userData</code>, <code>metaData</code> and <code>networkData</code> fields in the <code>status</code> section
are for the controller to store the reference to the secret that is
actually being used, whether it is from one of the spec fields, or
somehow generated. This is aimed at making a clear difference between
the desired state from the user (whether it is with a DataTemplate
reference, or direct <code>metaData</code> or <code>userData</code> secrets) and what the
controller is actually using.</p>
</div>
<div class="paragraph">
<p>The <code>dataTemplate</code> field consists of an object reference to a
Metal3DataTemplate object containing the templates for the metadata and
network data generation for this Metal3Machine. The <code>renderedData</code> field
is a reference to the Metal3Data object created for this machine. If the
dataTemplate field is set but either the <code>renderedData</code>, <code>metaData</code> or
<code>networkData</code> fields in the status are unset, then the Metal3Machine
controller will wait until it can find the Metal3Data object and the
rendered secrets. It will then populate those fields.</p>
</div>
<div class="paragraph">
<p>When CAPM3 controller will set the different fields in the
BareMetalHost, it will reference the metadata secret and the network
data secret in the BareMetalHost. If any of the <code>metaData</code> or
<code>networkData</code> status fields are unset, that field will also remain unset
on the BareMetalHost.</p>
</div>
<div class="paragraph">
<p>When the Metal3Machine gets deleted, the CAPM3 controller will remove
its ownerreference from the data template object. This will trigger the
deletion of the generated Metal3Data object and the secrets generated
for this machine.</p>
</div>
<div class="sect3">
<h4 id="_hostselector_examples">3.7.1. hostSelector Examples</h4>
<div class="paragraph">
<p>The `hostSelector field has two possible optional sub-fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>matchLabels</strong>&#8201;&#8212;&#8201;Key/value pairs of labels that must match exactly.</p>
</li>
<li>
<p><strong>matchExpressions</strong>&#8201;&#8212;&#8201;A set of expressions that must evaluate to true
for the labels on a <code>BareMetalHost</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Valid operators include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>!</strong>&#8201;&#8212;&#8201;Key does not exist. Values ignored.</p>
</li>
<li>
<p><strong>=</strong>&#8201;&#8212;&#8201;Key equals specified value. There must only be one value
specified.</p>
</li>
<li>
<p><strong>==</strong>&#8201;&#8212;&#8201;Key equals specified value. There must only be one value
specified.</p>
</li>
<li>
<p><strong>in</strong>&#8201;&#8212;&#8201;Value is a member of a set of possible values</p>
</li>
<li>
<p><strong>!=</strong>&#8201;&#8212;&#8201;Key does not equal the specified value. There must only be one
value specified.</p>
</li>
<li>
<p><strong>notin</strong>&#8201;&#8212;&#8201;Value not a member of the specified set of values.</p>
</li>
<li>
<p><strong>exists</strong>&#8201;&#8212;&#8201;Key exists. Values ignored.</p>
</li>
<li>
<p><strong>gt</strong>&#8201;&#8212;&#8201;Value is greater than the one specified. Value must be an
integer.</p>
</li>
<li>
<p><strong>lt</strong>&#8201;&#8212;&#8201;Value is less than the one specified. Value must be an
integer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example 1: Only consider a <code>BareMetalHost</code> with label <code>key1</code> set to
<code>value1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 2: Only consider <code>BareMetalHost</code> with both <code>key1</code> set to
<code>value1</code> AND <code>key2</code> set to <code>value2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
          key2: value2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 3: Only consider <code>BareMetalHost</code> with <code>key3</code> set to either <code>a</code>,
<code>b</code>, or <code>c</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchExpressions:
          - key: key3
            operator: in
            values: [‘a’, ‘b’, ‘c’]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 3: Only consider <code>BareMetalHost</code> with <code>key1</code> set to <code>value1</code> AND
<code>key2</code> set to <code>value2</code> AND <code>key3</code> set to either <code>a</code>, <code>b</code>, or <code>c</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
          key2: value2
        matchExpressions:
          - key: key3
            operator: in
            values: [‘a’, ‘b’, ‘c’]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_metal3machine_example">3.7.2. Metal3Machine example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Machine
metadata:
  name: controlplane-0
spec:
  image:
    url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
    checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
  hostSelector:
    matchLabels:
      key1: value1
    matchExpressions:
      key: key2
      operator: in
      values: {‘abc’, ‘123’, ‘value2’}
  dataTemplate:
    Name: controlplane-metadata
  metaData:
    Name: controlplane-0-metadata-0</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_machinedeployment">3.8. MachineDeployment</h3>
<div class="paragraph">
<p>MachineDeployment is a core Cluster API object that is similar to
deployment for pods. It refers to a KubeadmConfigTemplate and to a
Metal3MachineTemplate.</p>
</div>
<div class="paragraph">
<p>Example MachineDeployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: MachineDeployment
metadata:
  name: md-0
  labels:
    cluster.x-k8s.io/cluster-name: cluster
    nodepool: nodepool-0
spec:
  replicas: 1
  selector:
    matchLabels:
      cluster.x-k8s.io/cluster-name: cluster
      nodepool: nodepool-0
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: cluster
        nodepool: nodepool-0
    spec:
      version: 1.16
      bootstrap:
        configRef:
          name: md-0
          apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
          kind: KubeadmConfigTemplate
      infrastructureRef:
        name: md-0
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
        kind: Metal3MachineTemplate</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kubeadmconfigtemplate">3.9. KubeadmConfigTemplate</h3>
<div class="paragraph">
<p>This contains a template to generate KubeadmConfig.</p>
</div>
<div class="paragraph">
<p>Example KubeadmConfigTemplate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: KubeadmConfigTemplate
metadata:
  name: md-0
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          name: '{{ ds.meta_data.name }}'
          kubeletExtraArgs:
            node-labels: 'metal3.io/uuid={{ ds.meta_data.uuid }}'
      preKubeadmCommands:
        - apt update -y
        - &gt;-
          apt install apt-transport-https ca-certificates curl gnupg-agent
          software-properties-common -y
        - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        - &gt;-
          add-apt-repository "deb [arch=amd64]
          https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
        - apt update -y
        - apt install docker-ce docker-ce-cli containerd.io -y
        - usermod -aG docker ubuntu
        - &gt;-
          curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg
          | apt-key add -
        - &gt;-
          echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main'
          &gt; /etc/apt/sources.list.d/kubernetes.list
        - apt update
        - apt install -y kubelet kubeadm kubectl
        - systemctl enable --now kubelet</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metal3machinetemplate">3.10. Metal3MachineTemplate</h3>
<div class="paragraph">
<p>The Metal3MachineTemplate contains the template to create Metal3Machine.</p>
</div>
<div class="paragraph">
<p>Example Metal3MachineTemplate :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3MachineTemplate
metadata:
  name: md-0
spec:
  template:
    spec:
      image:
        url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
        checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
      hostSelector:
        matchLabels:
          key1: value1
        matchExpressions:
          key: key2
          operator: in
          values: {‘abc’, ‘123’, ‘value2’}
      dataTemplate:
        Name: md-0-metadata</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metal3datatemplate">3.11. Metal3DataTemplate</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataTemplate
metadata:
  name: nodepool-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Cluster
    name: cluster-1
spec:
  metaData:
    strings:
      - key: abc
        value: def
    objectNames:
      - key: name_m3m
        object: metal3machine
      - key: name_machine
        object: machine
      - key: name_bmh
        object: baremetalhost
    indexes:
      - key: index
        offset: 0
        step: 1
    ipAddressesFromIPPool:
      - key: ip
        Name: pool-1
    prefixesFromIPPool:
      - key: ip
        Name: pool-1
    gatewaysFromIPPool:
      - key: gateway
        Name: pool-1
    dnsServersFromIPPool:
      - key: dns
        Name: pool-1
    fromHostInterfaces:
      - key: mac
        interface: "eth0"
    fromLabels:
      - key: label-1
        object: machine
        label: mylabelkey
    fromAnnotations:
      - key: annotation-1
        object: machine
        annotation: myannotationkey
  networkData:
    links:
      ethernets:
        - type: "phy"
          id: "enp1s0"
          mtu: 1500
          macAddress:
            fromHostInterface: "eth0"
        - type: "phy"
          id: "enp2s0"
          mtu: 1500
          macAddress:
            fromHostInterface: "eth1"
      bonds:
        - id: "bond0"
          mtu: 1500
          macAddress:
            string: "XX:XX:XX:XX:XX:XX"
          bondMode: "802.1ad"
          bondLinks:
            - enp1s0
            - enp2s0
      vlans:
        - id: "vlan1"
          mtu: 1500
          macAddress:
            string: "YY:YY:YY:YY:YY:YY"
          vlanId: 1
          vlanLink: bond0
    networks:
      ipv4DHCP:
        - id: "provisioning"
          link: "bond0"

      ipv4:
        - id: "Baremetal"
          link: "vlan1"
          IPAddressFromIPPool: pool-1
          routes:
            - network: "0.0.0.0"
              netmask: 0
              gateway:
                fromIPPool: pool-1
              services:
                dns:
                  - "8.8.4.4"
                dnsFromIPPool: pool-1
      ipv6DHCP:
        - id: "provisioning6"
          link: "bond0"
      ipv6SLAAC:
        - id: "provisioning6slaac"
          link: "bond0"
      ipv6:
        - id: "Baremetal6"
          link: "vlan1"
          IPAddressFromIPPool: pool6-1
          routes:
            - network: "0::0"
              netmask: 0
              gateway:
                string: "2001:0db8:85a3::8a2e:0370:1"
              services:
                dns:
                  - "2001:4860:4860::8844"
                dnsFromIPPool: pool6-1
    services:
      dns:
        - "8.8.8.8"
        - "2001:4860:4860::8888"
status:
  indexes:
    "0": "machine-1"
  dataNames:
    "machine-1": nodepool-1-0
  lastUpdated: "2020-04-02T06:36:09Z"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This object will be reconciled by its own controller. When reconciled,
the controller will add a label pointing to the Metal3Cluster that has
nodes linking to this object. The spec contains a <code>metaData</code> and a
<code>networkData</code> field that contain a template of the values that will be
rendered for all nodes.</p>
</div>
<div class="paragraph">
<p>The <code>metaData</code> field will be rendered into a map of strings in yaml
format, while <code>networkData</code> will be rendered into a map equivalent of
<a href="https://docs.openstack.org/nova/latest/user/metadata.html#openstack-format-metadata">Nova
network_data.json</a>. On the target node, the network data will be
rendered as a json object that follows the format definition that can be
found
<a href="https://docs.openstack.org/nova/latest/_downloads/9119ca7ac90aa2990e762c08baea3a36/network_data.json">here</a>.</p>
</div>
<div class="sect3">
<h4 id="_metadata_specifications">3.11.1. Metadata Specifications</h4>
<div class="paragraph">
<p>The <code>metaData</code> field contains a list of items that will render data in
different ways. The following types of objects are available and accept
lists:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>strings</strong>: renders the given string as value in the metadata. It takes
a <code>value</code> attribute.</p>
</li>
<li>
<p><strong>objectNames</strong> : renders the name of the object that matches the type
given. It takes an <code>object</code> attribute, containing the type of the
object.</p>
</li>
<li>
<p><strong>indexes</strong>: renders the index of the current object, with the offset
from the <code>offset</code> field and using the step from the <code>step</code> field. The
following conditions must be matched : <code>offset</code> &gt;= 0 and <code>step</code> &gt;= 1 if
the step is unspecified (default value being 0), the controller will
automatically change it for 1. The <code>prefix</code> and <code>suffix</code> attributes are
to provide a prefix and a suffix for the rendered index.</p>
</li>
<li>
<p><strong>ipAddressesFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
</li>
<li>
<p><strong>prefixesFromIPPool</strong>: renders a network prefix from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
</li>
<li>
<p><strong>gatewaysFromIPPool</strong>: renders a network gateway from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
</li>
<li>
<p><strong>dnsServersFromIPPool</strong>: renders a dns servers list from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
</li>
<li>
<p><strong>fromHostInterfaces</strong>: renders the MAC address of the BareMetalHost
that matches the name given as value.</p>
</li>
<li>
<p><strong>fromLabels</strong>: renders the content of a label on an object or an empty
string if the label is absent. It takes an <code>object</code> attribute to specify
the type of the object where to fetch the label, and a <code>label</code> attribute
that contains the label key.</p>
</li>
<li>
<p><strong>fromAnnotations</strong>: renders the content of a annotation on an object or
an empty string if the annotation is absent. It takes an <code>object</code>
attribute to specify the type of the object where to fetch the
annotation, and an <code>annotation</code> attribute that contains the annotation
key.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For each object, the attribute <strong>key</strong> is required.</p>
</div>
</div>
<div class="sect3">
<h4 id="_networkdata_specifications">3.11.2. networkData specifications</h4>
<div class="paragraph">
<p>The <code>networkData</code> field will contain three items :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>links</strong>: a list of layer 2 interface</p>
</li>
<li>
<p><strong>networks</strong>: a list of layer 3 networks</p>
</li>
<li>
<p><strong>services</strong> : a list of services (DNS)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_links_specifications">Links specifications</h5>
<div class="paragraph">
<p>The object for the <strong>links</strong> section list can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ethernets</strong>: a list of ethernet interfaces</p>
</li>
<li>
<p><strong>bonds</strong>: a list of bond interfaces</p>
</li>
<li>
<p><strong>vlans</strong>: a list of vlan interfaces</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>links/ethernets</strong> objects contain the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>type</strong>: Type of the ethernet interface</p>
</li>
<li>
<p><strong>id</strong>: Interface name</p>
</li>
<li>
<p><strong>mtu</strong>: Interface MTU</p>
</li>
<li>
<p><strong>macAddress</strong>: an object to render the MAC Address</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>links/ethernets/type</strong> can be one of :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>bridge</p>
</li>
<li>
<p>dvs</p>
</li>
<li>
<p>hw_veb</p>
</li>
<li>
<p>hyperv</p>
</li>
<li>
<p>ovs</p>
</li>
<li>
<p>tap</p>
</li>
<li>
<p>vhostuser</p>
</li>
<li>
<p>vif</p>
</li>
<li>
<p>phy</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>links/ethernets/macAddress</strong> object can be one of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>string</strong>: with the desired Mac given as a string</p>
</li>
<li>
<p><strong>fromHostInterface</strong>: with the interface name from BareMetalHost
hardware details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>links/bonds</strong> object contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong>: Interface name</p>
</li>
<li>
<p><strong>mtu</strong>: Interface MTU</p>
</li>
<li>
<p><strong>macAddress</strong>: an object to render the MAC Address</p>
</li>
<li>
<p><strong>bondMode</strong>: The bond mode</p>
</li>
<li>
<p><strong>bondLinks</strong> : a list of links to use for the bond</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>links/bonds/bondMode</strong> can be one of :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>802.1ad</p>
</li>
<li>
<p>balance-rr</p>
</li>
<li>
<p>active-backup</p>
</li>
<li>
<p>balance-xor</p>
</li>
<li>
<p>broadcast</p>
</li>
<li>
<p>balance-tlb</p>
</li>
<li>
<p>balance-alb</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>links/vlans</strong> object contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong>: Interface name</p>
</li>
<li>
<p><strong>mtu</strong>: Interface MTU</p>
</li>
<li>
<p><strong>macAddress</strong>: an object to render the MAC Address</p>
</li>
<li>
<p><strong>vlanId</strong>: The vlan ID</p>
</li>
<li>
<p><strong>vlanLink</strong> : The link on which to create the vlan</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_the_networks_specifications">The networks specifications</h5>
<div class="paragraph">
<p>The object for the <strong>networks</strong> section can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ipv4</strong>: a list of ipv4 static allocations</p>
</li>
<li>
<p><strong>ipv4DHCP</strong>: a list of ipv4 DHCP based allocations</p>
</li>
<li>
<p><strong>ipv6</strong>: a list of ipv6 static allocations</p>
</li>
<li>
<p><strong>ipv6DHCP</strong>: a list of ipv6 DHCP based allocations</p>
</li>
<li>
<p><strong>ipv6SLAAC</strong>: a list of ipv6 SLAAC based allocations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>networks/ipv4</strong> object contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong>: the network name</p>
</li>
<li>
<p><strong>link</strong>: The name of the link to configure this network for</p>
</li>
<li>
<p><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em> object.
The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
</li>
<li>
<p><strong>routes</strong>: the list of route objects</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>_networks/ipv</em>/routes_* is a route object containing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>network</strong>: the subnet to reach</p>
</li>
<li>
<p><strong>netmask</strong>: the mask of the subnet as integer</p>
</li>
<li>
<p><strong>gateway</strong>: the gateway to use, it can either be given as a string in
<em>string</em> or as an IPPool name in <em>fromIPPool</em></p>
</li>
<li>
<p><strong>services</strong>: a list of services object as defined later</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>networks/ipv4Dhcp</strong> object contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong>: the network name</p>
</li>
<li>
<p><strong>link</strong>: The name of the link to configure this network for</p>
</li>
<li>
<p><strong>routes</strong>: the list of route objects</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>networks/ipv6</strong> object contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong>: the network name</p>
</li>
<li>
<p><strong>link</strong>: The name of the link to configure this network for</p>
</li>
<li>
<p><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em> object.
The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
</li>
<li>
<p><strong>routes</strong>: the list of route objects</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>networks/ipv6Dhcp</strong> object contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong>: the network name</p>
</li>
<li>
<p><strong>link</strong>: The name of the link to configure this network for</p>
</li>
<li>
<p><strong>routes</strong>: the list of route objects</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>networks/ipv6Slaac</strong> object contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong>: the network name</p>
</li>
<li>
<p><strong>link</strong>: The name of the link to configure this network for</p>
</li>
<li>
<p><strong>routes</strong>: the list of route objects</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_the_services_specifications">the services specifications</h5>
<div class="paragraph">
<p>The object for the <strong>services</strong> section can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>dns</strong>: a list of dns service with the ip address of a dns server</p>
</li>
<li>
<p><strong>dnsFromIPPool</strong>: the IPPool from which to fetch the dns servers list</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_metal3dataclaim_object">3.12. The Metal3DataClaim object</h3>
<div class="paragraph">
<p>A new object would be created, a Metal3DataClaim type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataClaim
metadata:
  name: machine-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Machine
    name: machine-1
spec:
  template:
    name: nodepool-1
status:
  renderedData:
    name: nodepool-1-0
  errorMessage: ""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>Metal3DataClaim</em> object will reference its target
<em>Metal3DataTemplate</em> object. In its status, the <em>renderedData</em> would
reference the <em>Metal3Data</em> object when it would be generated. In case of
error, the <em>errorMessage</em> would contain a description of the error.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_metal3data_object">3.13. The Metal3Data object</h3>
<div class="paragraph">
<p>The output of the controller would be a Metal3Data object,one per node
linking to the Metal3DataTemplate object and the associated secrets</p>
</div>
<div class="paragraph">
<p>The Metal3Data object would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Data
metadata:
  name: nodepool-1-0
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3DataTemplate
    name: nodepool-1
spec:
  index: 0
  metaData:
    name: machine-1-metadata
    namespace: default
  networkData:
    name: machine-1-metadata
    namespace: default
  metal3Machine:
    name: machine-1
    namespace: default
status:
  ready: true
  error: false
  errorMessage: ""</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Metal3Data will contain the index of this node, and links to the
secrets generated and to the Metal3Machine using this Metal3Data object.</p>
</div>
<div class="paragraph">
<p>If the Metal3DataTemplate object is updated, the generated secrets will
not be updated, to allow for reprovisioning of the nodes in the exact
same state as they were initially provisioned. Hence, to do an update,
it is necessary to do a rolling upgrade of all nodes.</p>
</div>
<div class="paragraph">
<p>The reconciliation of the Metal3DataTemplate object will also be
triggered by changes on Metal3Machines. In the case that a Metal3Machine
gets modified, if the <code>dataTemplate</code> references a Metal3DataTemplate,
that <em>Metal3DataClaim</em> object will be reconciled. There will be two
cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An already generated Metal3Data object exists for that
<em>Metal3DataClaim</em>. If the reference is not in the <em>Metal3DataClaim</em>
object, the reconciler will add it. The reconciler will also verify that
the required secrets exist. If they do not, they will be created.</p>
</li>
<li>
<p>if no Metal3Data exists for that <em>Metal3DataClaim</em>, then the
reconciler will create one and fill the respective field with the secret
name.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To create a Metal3Data object, the <em>Metal3DataClaim</em> controller will
select an index for that Metal3Machine. The selection happens by
selecting the lowest available index that is not in use. To do that, the
controller will list all existing Metal3Data object linked to this
Metal3DataTemplate and to get the unavailable indexes. The indexes
always start from 0 and increment by 1. The lowest available index is to
be used next. The <code>dataNames</code> field contains the map of Metal3Machine to
Metal3Data and the <code>indexes</code> contains the map of allocated indexes and
claims.</p>
</div>
<div class="paragraph">
<p>Once the next lowest available index is found, it will create the
Metal3Data object. The name would be a concatenation of the
Metal3DataTemplate name and index. Upon conflict, it will fetch again
the list to consider the new list of Metal3Data and try to create the
new object with the new index, this will happen until the new object is
created successfully. Upon success, it will render the content values,
and create the secrets containing the rendered data. The controller will
generate the content based on the <code>metaData</code> or <code>networkData</code> field of
the Metal3DataTemplate Specs. The <em>ready</em> field in <em>renderedData</em> will
then be set accordingly. If any error happens during the rendering, an
error message will be added.</p>
</div>
<div class="sect3">
<h4 id="_the_generated_secrets">3.13.1. The generated secrets</h4>
<div class="paragraph">
<p>The name of the secret will be made of a prefix and the index. The
Metal3Machine object name will be used as the prefix. A <code>-metadata-</code> or
<code>-networkdata-</code> will be added between the prefix and the index.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deployment_flow">3.14. Deployment flow</h3>
<div class="sect3">
<h4 id="_manual_secret_creation">3.14.1. Manual secret creation</h4>
<div class="paragraph">
<p>In the case where the Metal3Machine is created without a <code>dataTemplate</code>
value, if the <code>metaData</code> or <code>networkData</code> fields are set (one or both),
the Metal3Machine reconciler will fetch the secret, set the status field
and directly start the provisioning of the BareMetalHost using the
secrets if given. If one of the secrets does not exist, the controller
will wait to start the provisioning of the BareMetalHost until it
exists.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_secret_creation">3.14.2. Dynamic secret creation</h4>
<div class="paragraph">
<p>In the case where the Metal3Machine is created with a <code>dataTemplate</code>
value, the Metal3Machine reconciler will create a <em>Metal3DataClaim</em> for
that object.</p>
</div>
<div class="paragraph">
<p>The <em>Metal3DataClaim</em> would then be reconciled, and its controller will
create an index for this <em>Metal3DataClaim</em> if it does not exist yet, and
create a Metal3Data object with the index. Upon success, it will set the
<em>ready</em> field to true, and the <em>renderedData</em> field to reference the
<em>Metal3Data</em> object.</p>
</div>
<div class="paragraph">
<p>The Metal3Data reconciler will then generate the secrets, based on the
index, the Metal3DataTemplate and the machine. Once created, it will set
the status field <code>ready</code> to True.</p>
</div>
<div class="paragraph">
<p>Once the Metal3Data object is ready, the Metal3Machine controller will
fetch the secrets that have been created (one or both) and use them to
start provisioning the BareMetalHost.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hybrid_configuration">3.14.3. Hybrid configuration</h4>
<div class="paragraph">
<p>If the Metal3Machine object is created with a <code>dataTemplate</code> field set,
but one of the <code>metaData</code> or <code>networkData</code> is also set in the spec, this
one will override the template generation for this specific secret. i.e.
if the user sets the three fields, the controller will use the user
input secret for both.</p>
</div>
<div class="paragraph">
<p>This means that some hybrid scenarios are supported, where the user can
give directly the <code>metaData</code> secret and let the controller render the
<code>networkData</code> secret through the Metal3DataTemplate object.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metal3_dev_env_examples">3.15. Metal3 dev env examples</h3>
<div class="paragraph">
<p>You can find CR examples in the
<a href="https://github.com/metal3-io/metal3-dev-env">Metal3-io dev env project</a>,
in the
<a href="https://github.com/metal3-io/metal3-dev-env/tree/master/vm-setup/roles/v1aX_integration_test/templates">template
folder</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_capm3_testing">4. CAPM3 testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document outlines the testing strategy applied in CAPM3. All
developers should follow those guidelines to ensure uniformity and
quality in the tests.</p>
</div>
<div class="sect2">
<h3 id="_code_coverage">4.1. Code coverage</h3>
<div class="paragraph">
<p>The minimum code coverage required for the <code>api</code>, <code>baremetal</code> and
<code>controllers</code> folders is <strong>80%</strong>. Any PR introducing new code should
include tests for the new code and the developers should verify that the
code coverage did not decrease due to their PR. The generated code
should be excluded from the coverage (files starting with
<code>zz_generated.</code>)</p>
</div>
<div class="paragraph">
<p>In order to run the tests and get the cover profile, you can use make.
You can use the auto-completion of the make command to see the available
targets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">make test</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">make unit</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also run the tests in a container exactly as they are run in CI
:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">./hack/unit.sh</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_files">4.2. Testing files</h3>
<div class="paragraph">
<p>For each file in each package, a test file should be created, named
after the original file <code>&lt;filename&gt;_test.go</code>, containing the unit tests
for the functions defined in the file.</p>
</div>
<div class="paragraph">
<p>A test file can also be created to contain integration tests, named
after the original file <code>&lt;filename&gt;_integration_test.go</code>. This file
should only contain integration tests, for example to test the
controllers with the managers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mocking">4.3. Mocking</h3>
<div class="paragraph">
<p>To mock the interface, we use mockgen and the gomock module to write the
tests. The mock code should be placed in a folder <code>mocks</code> within the
folder containing the mocked code. The mock file should be named after
the original file containing the interface,
<code>zz_generated.&lt;filename&gt;.go</code>, and the package should be named after the
original package, <code>&lt;packagename&gt;_mocks</code></p>
</div>
<div class="paragraph">
<p>Unit tests should be performed by mocking the interface of other
modules, or using fake clients from controller-runtime package
<code>sigs.k8s.io/controller-runtime/pkg/client/fake</code> or
<code>"k8s.io/client-go/kubernetes/fake"</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_guidelines">4.4. Testing Guidelines</h3>
<div class="ulist">
<ul>
<li>
<p>The tests should use Ginkgo and Gomega, for example for the
assertions, when needed. Other libraries should not be used to keep
uniformity in the tests.</p>
</li>
<li>
<p>The tests should be table-driven when there are multiple cases.</p>
</li>
<li>
<p>Table-driven tests should use subtests to improve the readability of
the results</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployment_workflow">5. Deployment workflow</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_deploying_the_controllers">5.1. Deploying the controllers</h3>
<div class="paragraph">
<p>The following controllers need to be deployed :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CAPI</p>
</li>
<li>
<p>CAPBK or alternative</p>
</li>
<li>
<p>CACPK or alternative</p>
</li>
<li>
<p>CAPM3</p>
</li>
<li>
<p>Baremetal Operator, with Ironic setup</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_requirements_2">5.2. Requirements</h3>
<div class="paragraph">
<p>The cluster should either :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>be deployed with an external cloud provider, that would be deployed as
part of the userData and would set the providerIDs based on the
BareMetalHost UID.</p>
</li>
<li>
<p>Be deployed with the ProviderID set to be the BareMetalHostUUID</p>
</li>
<li>
<p>be deployed with each node with the label "metal3.io/uuid" set to the
BareMetalHost UID that is provided by ironic to cloud-init through the
metadata <code>ds.meta_data.uuid</code>. This can be achieved by setting the
following in the KubeadmConfig :</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">nodeRegistration:
  name: '{{ ds.meta_data.name }}'
  kubeletExtraArgs:
    node-labels: 'metal3.io/uuid={{ ds.meta_data.uuid }}'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_the_crs">5.3. Deploying the CRs</h3>
<div class="paragraph">
<p>You can deploy the CRs all at the same time, the controllers will take
care of following the correct flow. An outline of the workflow is below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The CAPI controller will set the OwnerRef on the Metal3Cluster
referenced by the Cluster, on the KubeadmControlPlane, and all machines,
KubeadmConfig and Metal3Machines created by the user or by a
MachineDeployment.</p>
</li>
<li>
<p>The CAPM3 controller will verify the controlPlaneEndpoint field and
populate the status with ready field set to true.</p>
</li>
<li>
<p>The CAPI controller will set infrastructureReady field to true on the
Cluster</p>
</li>
<li>
<p>The CAPI controller will set the OwnerRef</p>
</li>
<li>
<p>The KubeadmControlPlane controller will wait until the cluster has
infrastructureReady set to true, and generate the first machine,
Metal3Machine and KubeadmConfig.</p>
</li>
<li>
<p>CABPK will generate the cloud-init output for this machine and create
a secret containing it.</p>
</li>
<li>
<p>The CAPI controller will copy the userData secret name into the
machine object and set the bootstrapReady field to true.</p>
</li>
<li>
<p>Once the secrets exists, the CAPM3 controller will select, if
possible, a BareMetalHost that matches the criteria, or wait until one
is available.</p>
</li>
<li>
<p>Once the machine has been associated with a BaremetalHost, the CAPM3
controller will check if the Metal3Machine references a
Metal3DataTemplate object. In that case, it will set an OwnerReference
on the Metal3DataTemplate object referencing the Metal3Machine and wait
for the metadata and/or network data secrets to be created.</p>
</li>
<li>
<p>The CAPM3 controller reconciling the Metal3DataTemplate object will
select the lowest available index for the new machine and create a
Metal3Data object that will then create the secrets containing the
rendered data.</p>
</li>
<li>
<p>The CAPM3 controller will then set the BareMetalHost spec accordingly
to the Metal3Machine specs.</p>
</li>
<li>
<p>The BareMetal Operator will then start the deployment.</p>
</li>
<li>
<p>After deployment, the BaremetalHost will be in provisioned state.
However, initialization is not complete. If deploying without cloud
provider, CAPM3 can wait until the target cluster is up and the node
appears, then fetch the node by matching the label
<code>metal3.io/uuid=&lt;bmh-uuid&gt;</code> and set the providerID to
<code>metal3://&lt;bmh-uuid&gt;</code>. The Metal3Machine ready status will be set to
true and the providerID will be set to <code>metal3://&lt;bmh-uuid&gt;</code> on the
Metal3Machine.</p>
</li>
<li>
<p>CAPI will access the target cluster and compare the providerID on the
node to the providerID of the Machine, copied from the metal3machine. If
matching, the control plane initialized status will be set to true and
the machine state to running.</p>
</li>
<li>
<p>CACPK will then do the same for each further controller node until
reaching the desired replicas number, one by one, triggering the same
workflow. Meanwhile, as soon as the controlplane is initialized, CABPK
will generate the user data for all other machines, triggering their
deployment.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deletion">5.4. Deletion</h3>
<div class="paragraph">
<p>Deleting the cluster object will trigger the deletion of all related
objects except for KubeadmConfigTemplates, Metal3MachineTemplates,
Metal3DataTemplates and BareMetalHosts, and the secrets related to the
BareMetalHosts.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-10-25 01:55:14 +0300
</div>
</div>
</body>
</html>